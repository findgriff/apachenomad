generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  status          String
  origin          String
  endFixed        String?
  cities          String[]
  windowStart     DateTime
  windowEnd       DateTime
  nightsMin       Int
  nightsMax       Int
  weekendOnly     Boolean  @default(false)
  cabin           String   @default("ECONOMY")
  maxConnections  Int      @default(1)
  includeAirlines String[] @default([])
  excludeAirlines String[] @default([])
  currency        String   @default("EUR")
  budgetJobCents  Int
  meta            Json     @default("{}")
  PriceMatrix     PriceMatrix[]
  Result          Result[]
}

model PriceMatrix {
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  orig        String
  dest        String
  depDate     DateTime
  filtersHash String
  offerId     String?
  priceCents  Int?
  currency    String?
  legs        Json?
  provider    String   @default("amadeus")
  fetchedAt   DateTime @default(now())

  @@id([jobId, orig, dest, depDate, filtersHash])
}

model Result {
  jobId            String
  job              Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  rank             Int
  cityOrder        String[]
  dates            DateTime[]
  totalPriceCents  Int
  currency         String
  pricingDeltaPct  Float
  deepLink         String
  legs             Json
  pricedAt         DateTime

  @@id([jobId, rank])
}

model ApiSpend {
  id           String   @id @default(uuid())
  jobId        String?
  provider     String
  api          String
  calls        Int
  estCostCents Int
  window       DateTime

  @@unique([jobId, provider, api, window])
}
